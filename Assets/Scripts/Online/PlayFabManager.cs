using PlayFab;
using PlayFab.ClientModels;
using UnityEngine;
using TMPro;
using System.Collections;
using UnityEngine.ProBuilder.MeshOperations;

public class PlayFabManager : MonoBehaviour
{
  //public TextMeshProUGUI NameText;
    public GameObject ErrorLoginWindow;
    public GameObject BanWindow;
    public GameObject NotFoundOrDeleteAccountWindow;
    public GameObject Buttons;
    public GameObject DevelopersSegmentObject;

    public ConnectManager ConnectManager;

    private string playFabId;

    private void Start()
    {
        LoginWithAnonymous();
    }

    private void LoginWithAnonymous()
    {
        // логиним игрока 

        string customId = SystemInfo.deviceUniqueIdentifier;
        var request = new LoginWithCustomIDRequest
        {
            CustomId = customId,
            CreateAccount = true
        };

        PlayFabClientAPI.LoginWithCustomID(request, OnLoginSuccess, OnLoginError);
    }

    private void OnLoginSuccess(LoginResult result)
    {
        // метод вызывается при успешном логине

        playFabId = result.PlayFabId;
      //NameText.text = playFabId;
        Debug.Log("Successful login: " + playFabId);

        PlayFabClientAPI.GetAccountInfo(new GetAccountInfoRequest(), OnGetAccountInfoSuccess, OnBanned);
        GetPlayerSegments();
    }

    private void OnGetAccountInfoSuccess(GetAccountInfoResult result)
    {
        // чекаем акк и проверяем забанен ли игрок или нет

        if (result.AccountInfo.TitleInfo.isBanned == true)
        {
            Debug.Log("The player is banned.");
        }
        else
        {
            Debug.Log("The player is successfully authorized and not banned.");
        }
    }

    private void OnBanned(PlayFabError fabError)
    {
        Debug.Log("The player is banned.");
        StartCoroutine(BanWindowWaitForSecondCoroutine());
        Buttons.SetActive(false);
    }

    private void OnAccountNotFoundOrDelete(PlayFabError fabError)
    {
        Debug.Log("The player account not found or delete.");
        StartCoroutine(NotFoundOrDeleteWindowWaitForSecondCoroutine());
        Buttons.SetActive(false);
    }

    private void OnLoginError(PlayFabError error)
    {
        // метод вызывается когда произошла ошибка логина

        Debug.LogError("Login failed: " + error.ErrorMessage);

        if (error.Error == PlayFabErrorCode.AccountBanned)
        {
            OnBanned(error);
        }
        else 
        {
            if (ConnectManager.Online == true)
            {
                StartCoroutine(ErrorWindowWaitForSecondCoroutine());
                Buttons.SetActive(false);
            }
            else
            {
                Buttons.SetActive(true);
            }
        }

        if (error.Error == PlayFabErrorCode.AccountDeleted && error.Error == PlayFabErrorCode.AccountNotFound)
        {
            OnAccountNotFoundOrDelete(error);
        }
        
    }

    private IEnumerator ErrorWindowWaitForSecondCoroutine()
    {
        yield return new WaitForSeconds(0.8f);
        ErrorLoginWindow.SetActive(true);
    }

    private IEnumerator BanWindowWaitForSecondCoroutine()
    {
        yield return new WaitForSeconds(0.8f);
        BanWindow.SetActive(true);
    }
    private IEnumerator NotFoundOrDeleteWindowWaitForSecondCoroutine()
    {
        yield return new WaitForSeconds(0.8f);
        NotFoundOrDeleteAccountWindow.SetActive(true);
    }

    private void GetPlayerSegments()
    {
        // тут чекаем акк и смотрим в каких сегментах состоит игрок

        var request = new GetPlayerSegmentsRequest
        {
            PlayFabId = playFabId
        };

        PlayFabClientAPI.GetPlayerSegments(request, OnGetPlayerSegmentsSuccess, OnGetPlayerSegmentsFailure);
    }

    private void OnGetPlayerSegmentsSuccess(GetPlayerSegmentsResult result)
    {
        // успешная проверка сегментов игрока

        Debug.Log("Segments for the player: " + playFabId);

        if (result.Segments != null && result.Segments.Count > 0)
        {
            foreach (var segment in result.Segments)
            {
                Debug.Log("Segment name: " + segment.Name);
                if (segment.Name == "Developers")
                {
                    // это короч когда ты разраб то включается объект

                    DevelopersSegmentObject.SetActive(true);
                }
            }
        }
        else
        {
            Debug.Log("This player does not belong to any segment.");
        }
    }

    private void OnGetPlayerSegmentsFailure(PlayFabError error)
    {
        // не успешная проверка сегментов игрока

        Debug.LogError("Error receiving segments: " + error.GenerateErrorReport());
    }
}
